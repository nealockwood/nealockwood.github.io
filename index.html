<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CPI Inflation Forecast Revision Term Structure</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
    background: #f7f5f0;
    color: #333;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 60px 20px;
  }
  .container { max-width: 880px; width: 100%; }
  h1 { font-size: 1.5em; font-weight: 700; color: #1a1a2e; margin-bottom: 4px; }
  .subtitle { font-size: 0.85em; color: #888; margin-bottom: 28px; }
  .controls {
    display: flex; align-items: center; gap: 24px;
    margin-bottom: 24px; flex-wrap: wrap;
  }
  .control-group { display: flex; align-items: center; gap: 8px; }
  .control-label { font-size: 0.85em; font-weight: 600; color: #555; }
  select {
    font-size: 0.9em; padding: 6px 12px;
    border: 1px solid #d8d5ce; border-radius: 6px;
    background: #fff; color: #333; cursor: pointer; outline: none;
    transition: border-color 0.2s;
  }
  select:hover { border-color: #8b9dc3; }
  select:focus { border-color: #8b9dc3; box-shadow: 0 0 0 2px rgba(139,157,195,0.2); }
  label.checkbox-label {
    font-size: 0.85em; color: #555; cursor: pointer;
    display: flex; align-items: center; gap: 6px;
  }
  input[type="checkbox"] { accent-color: #8b9dc3; width: 15px; height: 15px; }
  #plot { width: 100%; height: 500px; border-radius: 8px; }
  .legend-note { font-size: 0.78em; color: #999; margin-top: 8px; }
  .footnote { font-size: 0.75em; color: #aaa; margin-top: 12px; font-style: italic; }
</style>
</head>
<body>

<div class="container">
  <h1>CPI Inflation Forecast Revision Term Structure</h1>
  <p class="subtitle">Cross-sectional distribution of revisions to CPI inflation forecasts by horizon</p>

  <div class="controls">
    <div class="control-group">
      <span class="control-label">Quarter</span>
      <select id="quarter-select"></select>
    </div>
    <label class="checkbox-label">
      <input type="checkbox" id="nonzero-check" checked>
      Only forecasters who revised
    </label>
    <label class="checkbox-label" style="border: 1.5px solid #8b9dc3; border-radius: 5px; padding: 3px 8px;">
      <input type="checkbox" id="lagged-check">
      Show h=−1 
    </label>
  </div>

  <div id="plot"></div>
  <p class="legend-note">Black dot = median  &middot;  Bars = 5th–95th percentile</p>
  <p class="footnote">h=−1 is the lagged nowcast error, available beginning circa 1992.</p>
</div>

<script>
let allData = [];

// RCPI_0 = h=-1 (lagged nowcast error), RCPI_1 = h=0 (nowcast), etc.
const ALL_RCOLS = ['RCPI_0','RCPI_1','RCPI_2','RCPI_3','RCPI_4','RCPI_B','RCPI_C','RCPI_5Y','RCPI_10Y'];
const ALL_XLABELS = ['h=−1<br>lag','h=0<br>nowcast','h=1<br>1Q','h=2<br>2Q','h=3<br>3Q','B<br>next yr','C<br>yr after','5Y','10Y'];

function percentile(arr, p) {
  const s = arr.slice().sort((a, b) => a - b);
  const idx = (p / 100) * (s.length - 1);
  const lo = Math.floor(idx), hi = Math.ceil(idx);
  return lo === hi ? s[lo] : s[lo] + (s[hi] - s[lo]) * (idx - lo);
}

function updatePlot() {
  const sel = document.getElementById('quarter-select').value;
  const nonzeroOnly = document.getElementById('nonzero-check').checked;
  const showLagged = document.getElementById('lagged-check').checked;

  const startIdx = showLagged ? 0 : 1;
  const RCOLS = ALL_RCOLS.slice(startIdx);
  const XLABELS = ALL_XLABELS.slice(startIdx);

  const [year, quarter] = sel.split('Q');
  const rows = allData.filter(r => String(r.YEAR) === year && String(r.QUARTER) === quarter);

  const medians = [], p5s = [], p95s = [], counts = [], totals = [], pctNonzero = [];

  for (const col of RCOLS) {
    let allVals = rows.map(r => parseFloat(r[col])).filter(v => !isNaN(v));
    const total = allVals.length;
    const nNonzero = allVals.filter(v => v !== 0).length;
    const pct = total > 0 ? Math.round(100 * nNonzero / total) : null;

    let vals = nonzeroOnly ? allVals.filter(v => v !== 0) : allVals;
    if (vals.length >= 2) {
      medians.push(percentile(vals, 50));
      p5s.push(percentile(vals, 5));
      p95s.push(percentile(vals, 95));
    } else {
      medians.push(null); p5s.push(null); p95s.push(null);
    }
    counts.push(vals.length);
    totals.push(total);
    pctNonzero.push(pct);
  }

  const xIdx = Array.from({length: RCOLS.length}, (_, i) => i);
  const traces = [];

  for (let i = 0; i < RCOLS.length; i++) {
    if (medians[i] === null) continue;
    const isLagged = showLagged && i === 0;
    const stemColor = isLagged ? '#c4956a' : '#8b9dc3';
    const capW = 0.1;

    traces.push({ x: [i, i], y: [p5s[i], p95s[i]], mode: 'lines',
      line: { color: stemColor, width: 2, dash: isLagged ? 'dot' : 'solid' },
      showlegend: false, hoverinfo: 'skip' });
    traces.push({ x: [i-capW, i+capW], y: [p95s[i], p95s[i]], mode: 'lines',
      line: { color: stemColor, width: 2 }, showlegend: false, hoverinfo: 'skip' });
    traces.push({ x: [i-capW, i+capW], y: [p5s[i], p5s[i]], mode: 'lines',
      line: { color: stemColor, width: 2 }, showlegend: false, hoverinfo: 'skip' });
  }

  // Median dots
  const validIdx = xIdx.filter((_, i) => medians[i] !== null);
  const validMedians = medians.filter(m => m !== null);
  const validHover = xIdx.map((idx, i) => medians[i] !== null
    ? `${XLABELS[i].replace('<br>',' ')}<br>Median: ${medians[i].toFixed(2)}<br>n=${counts[i]}<extra></extra>` : null
  ).filter(x => x !== null);

  // Split lagged dot if showing
  if (showLagged && medians[0] !== null) {
    traces.push({ x: [0], y: [medians[0]], mode: 'markers',
      marker: { color: '#fff', size: 9, line: { color: '#1a1a2e', width: 2 } },
      showlegend: false, hovertemplate: [validHover[0]] });
    traces.push({ x: validIdx.slice(1), y: validMedians.slice(1), mode: 'markers',
      marker: { color: '#1a1a2e', size: 9 }, showlegend: false,
      hovertemplate: validHover.slice(1) });
  } else {
    traces.push({ x: validIdx, y: validMedians, mode: 'markers',
      marker: { color: '#1a1a2e', size: 9 }, showlegend: false,
      hovertemplate: validHover });
  }

  // Zero line
  traces.push({ x: [-0.6, RCOLS.length - 0.4], y: [0, 0], mode: 'lines',
    line: { color: '#aaa', width: 0.8 }, showlegend: false, hoverinfo: 'skip' });

  // Divider positions shift depending on whether lagged is shown
  const qEnd = showLagged ? 5.5 : 4.5;
  const aEnd = showLagged ? 7.5 : 6.5;
  const qMid = showLagged ? 3 : 2;
  const aMid = showLagged ? 6.5 : 5.5;
  const lrMid = showLagged ? 8.5 : 7.5;

  // Pct nonzero annotations along bottom
  const pctAnnotations = xIdx.map((i) => ({
    x: i, y: -0.18, xref: 'x', yref: 'paper',
    text: pctNonzero[i] !== null ? `${pctNonzero[i]}%` : '—',
    showarrow: false, font: { size: 9.5, color: '#999' }
  }));

  const BG = '#f7f5f0';
  const layout = {
    title: { text: `<b>${sel}</b>`,
      font: { size: 15, color: '#1a1a2e', family: '-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica Neue, Arial, sans-serif' },
      x: 0.01, xanchor: 'left', y: 0.97 },
    xaxis: {
      tickvals: xIdx, ticktext: XLABELS,
      tickfont: { size: 10.5, color: '#555' },
      range: [-0.6, RCOLS.length - 0.4],
      showgrid: false, zeroline: false,
      linecolor: '#e0ddd6', linewidth: 0.5,
    },
    yaxis: {
      title: { text: 'Revision (pp)', font: { size: 11, color: '#555' }, standoff: 10 },
      tickfont: { size: 10, color: '#666' },
      gridcolor: '#e0ddd6', gridwidth: 0.5,
      zeroline: false, linecolor: '#e0ddd6', linewidth: 0.5,
    },
    shapes: [
      { type: 'line', x0: qEnd, x1: qEnd, y0: 0, y1: 1, yref: 'paper', line: { color: '#e0ddd6', width: 0.8 } },
      { type: 'line', x0: aEnd, x1: aEnd, y0: 0, y1: 1, yref: 'paper', line: { color: '#e0ddd6', width: 0.8 } },
    ],
    annotations: [
      { x: qMid, y: 1.06, xref: 'x', yref: 'paper', text: '<i>Quarterly</i>', showarrow: false, font: { size: 10, color: '#999' } },
      { x: aMid, y: 1.06, xref: 'x', yref: 'paper', text: '<i>Annual</i>', showarrow: false, font: { size: 10, color: '#999' } },
      { x: lrMid, y: 1.06, xref: 'x', yref: 'paper', text: '<i>Long-run</i>', showarrow: false, font: { size: 10, color: '#999' } },
      // Row label for pct nonzero
      { x: -0.55, y: -0.18, xref: 'x', yref: 'paper', xanchor: 'right',
        text: '<i>% revised</i>', showarrow: false, font: { size: 9.5, color: '#999' } },
      ...pctAnnotations,
    ],
    plot_bgcolor: BG, paper_bgcolor: BG,
    margin: { t: 60, b: 100, l: 55, r: 20 },
    hovermode: 'closest', showlegend: false,
  };

  Plotly.react('plot', traces, layout, { responsive: true, displayModeBar: false });
}

const csvPath = 'Individual_CPI_with_revisions.csv';
Papa.parse(csvPath, {
  download: true, header: true, skipEmptyLines: true,
  complete: function(results) {
    allData = results.data;
    const yqSet = new Set();
    for (const r of allData) {
      if (r.YEAR && r.QUARTER) yqSet.add(`${r.YEAR}Q${r.QUARTER}`);
    }
    const quarters = Array.from(yqSet).sort((a, b) => {
      const [ay, aq] = a.split('Q').map(Number);
      const [by, bq] = b.split('Q').map(Number);
      return ay !== by ? ay - by : aq - bq;
    });
    const select = document.getElementById('quarter-select');
    for (const q of quarters) {
      const opt = document.createElement('option');
      opt.value = q; opt.textContent = q;
      select.appendChild(opt);
    }
    select.value = quarters[quarters.length - 1];
    updatePlot();
  }
});

document.getElementById('quarter-select').addEventListener('change', updatePlot);
document.getElementById('nonzero-check').addEventListener('change', updatePlot);
document.getElementById('lagged-check').addEventListener('change', updatePlot);
</script>
</body>
</html>
